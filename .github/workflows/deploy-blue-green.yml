name: deploy
on:
  workflow_dispatch:
    inputs:
      track:
        description: "blue or green"
        required: true
        default: "green"
        type: choice
        options: [ "blue", "green" ]
      image_tag:
        description: "Image tag (default SHA)"
        required: false
jobs:
  deploy-candidate:
    runs-on: ubuntu-latest
    environment: Staging
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Get AKS Context
        run: az aks get-credentials -n ${{ secrets.AKS_NAME }} -g ${{ secrets.AKS_RG }} --overwrite-existing
      - name: Helm Upgrade Candidate
        run: |
          TAG="${{ inputs.image_tag || github.sha }}"
          TRACK="${{ inputs.track }}"
          VALUES="apps/sample-web/values-${TRACK}.yaml"
          helm upgrade --install "sample-${TRACK}" apps/sample-web/charts/sample \
            -f $VALUES --set image.tag=$TAG
      - name: Smoke Test
        run: ./scripts/smoke.sh

  cutover:
    needs: deploy-candidate
    runs-on: ubuntu-latest
    environment: Production   # manual approval here
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Install yq
        run: sudo snap install yq
      - name: Get AKS Context
        run: az aks get-credentials -n ${{ secrets.AKS_NAME }} -g ${{ secrets.AKS_RG }} --overwrite-existing
      - name: Shift Traffic to Candidate (NGINX canary to 100%)
        run: |
          TRACK="${{ inputs.track }}"
          if [ "$TRACK" = "green" ]; then VALUES="apps/sample-web/values-green.yaml"; else VALUES="apps/sample-web/values-blue.yaml"; fi
          yq -i '.ingress.annotations."nginx.ingress.kubernetes.io/canary-weight" = "100"' $VALUES
          helm upgrade --install "sample-${TRACK}" apps/sample-web/charts/sample -f $VALUES
